<template>
  <div class="flex flex-col">
    <!-- ğŸ”¹ Ù‡Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
    <div class="fixed top-0 left-0 right-0 w-full bg-background/95 backdrop-blur-lg border-b border-border z-[100] block lg:hidden">
      <div class="flex items-center justify-between w-full p-4">
        <div class="flex items-center gap-3">
          <button @click="goBack" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-accent transition-colors">
            <i class="ti ti-arrow-right text-xl text-foreground"></i>
          </button>
          <h1 class="text-lg font-semibold text-foreground">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h1>
        </div>
        
        <div class="flex items-center gap-2">
          <!-- Ø¯Ú©Ù…Ù‡ ÙØ±Ù… Ø§Ø±ØªØ¨Ø§Ø· -->
          <button
            @click.stop="goToLeadCapture"
            type="button"
            class="bg-primary text-primary-foreground px-3 py-2 rounded-xl flex items-center gap-2 relative z-[101]"
          >
            <i class="ti ti-message text-base"/>
            <span class="text-sm font-medium">ÙØ±Ù… Ø§Ø±ØªØ¨Ø§Ø·</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ğŸ”¹ Skeleton Loading State -->
    <div v-if="isPageLoading" class="w-full grid grid-cols-1 lg:grid-cols-6 gap-4 lg:pt-6 pb-24 lg:pb-6 animate-pulse">
      <!-- ÙØ±Ù… Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª - Skeleton -->
      <div class="lg:col-span-4 min-h-0 px-1 lg:px-0 space-y-6">
        
        <!-- Layout Selector Skeleton -->
        <div class="bg-card p-4 rounded-xl border border-border">
          <div class="h-5 w-32 bg-muted rounded mb-3"></div>
          <div class="flex gap-3">
            <div class="h-16 flex-1 bg-muted rounded-xl"></div>
            <div class="h-16 flex-1 bg-muted rounded-xl"></div>
            <div class="h-16 flex-1 bg-muted rounded-xl"></div>
          </div>
        </div>
        
        <!-- TabAbout Skeleton -->
        <div class="bg-card p-4 sm:p-6 rounded-xl border border-border space-y-4">
          <!-- Avatar & Banner -->
          <div class="flex items-center gap-4">
            <div class="w-20 h-20 bg-muted rounded-full"></div>
            <div class="flex-1 space-y-2">
              <div class="h-5 w-3/4 bg-muted rounded"></div>
              <div class="h-4 w-1/2 bg-muted rounded"></div>
            </div>
          </div>
          <!-- Form fields -->
          <div class="space-y-3">
            <div class="h-10 bg-muted rounded-lg"></div>
            <div class="h-10 bg-muted rounded-lg"></div>
            <div class="h-20 bg-muted rounded-lg"></div>
          </div>
        </div>
        
        <!-- Lead Form Switch Skeleton -->
        <div class="bg-card p-4 sm:p-6 rounded-xl border border-border">
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <div class="h-5 w-40 bg-muted rounded"></div>
              <div class="h-4 w-56 bg-muted rounded"></div>
            </div>
            <div class="w-11 h-6 bg-muted rounded-full"></div>
          </div>
        </div>
        
        <!-- Links List Skeleton -->
        <div class="space-y-3">
          <div class="h-6 w-36 bg-muted rounded"></div>
          <div class="space-y-2">
            <div class="bg-card border border-border rounded-xl p-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-6 h-8 bg-muted rounded"></div>
                <div class="w-10 h-10 bg-muted rounded-lg"></div>
                <div class="h-5 w-32 bg-muted rounded"></div>
              </div>
              <div class="flex gap-2">
                <div class="w-8 h-8 bg-muted rounded-lg"></div>
                <div class="w-8 h-8 bg-muted rounded-lg"></div>
              </div>
            </div>
            <div class="bg-card border border-border rounded-xl p-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-6 h-8 bg-muted rounded"></div>
                <div class="w-10 h-10 bg-muted rounded-lg"></div>
                <div class="h-5 w-28 bg-muted rounded"></div>
              </div>
              <div class="flex gap-2">
                <div class="w-8 h-8 bg-muted rounded-lg"></div>
                <div class="w-8 h-8 bg-muted rounded-lg"></div>
              </div>
            </div>
            <div class="bg-card border border-border rounded-xl p-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-6 h-8 bg-muted rounded"></div>
                <div class="w-10 h-10 bg-muted rounded-lg"></div>
                <div class="h-5 w-36 bg-muted rounded"></div>
              </div>
              <div class="flex gap-2">
                <div class="w-8 h-8 bg-muted rounded-lg"></div>
                <div class="w-8 h-8 bg-muted rounded-lg"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Add Content Card Skeleton -->
        <div class="bg-card rounded-xl p-6 border border-border">
          <div class="flex gap-4 mb-6">
            <div class="w-12 h-12 bg-muted rounded-xl"></div>
            <div class="flex-1 space-y-2">
              <div class="h-5 w-28 bg-muted rounded"></div>
              <div class="h-4 w-full bg-muted rounded"></div>
            </div>
          </div>
          <div class="h-12 bg-muted rounded-xl"></div>
        </div>
      </div>
      
      <!-- Preview Skeleton - Desktop -->
      <div class="lg:col-span-2 hidden lg:block">
        <div class="sticky top-6">
          <div class="bg-card rounded-2xl border border-border p-4 space-y-4">
            <div class="h-6 w-24 bg-muted rounded mx-auto"></div>
            <div class="aspect-[9/16] bg-muted rounded-xl"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸ”¹ Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
    <div v-else class="w-full grid grid-cols-1 lg:grid-cols-6 gap-4  lg:pt-6 pb-24 lg:pb-6">
      <!-- ÙØ±Ù… Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
      <div class="lg:col-span-4 min-h-0 px-1 lg:px-0">
        
        <!-- ØªØºÛŒÛŒØ± Ú†ÛŒØ¯Ù…Ø§Ù† -->
        <div class="mb-6">
          <LayoutSelector 
            v-model="selectedLayout"
            @layout-changed="handleLayoutChange"
            @confirm="handleLayoutConfirm"
          />
        </div>
        
        <TabAbout
            :cardId="cardId"
            v-model:form="formStore.value"
            @open-preview="showPreviewMobile = true"
            class="bg-card p-4 sm:p-6 rounded-xl mb-6 border border-border "
        />

        <!-- Ø³ÙˆØ¦ÛŒÚ† ÙØ±Ù… Ù„ÛŒØ¯ -->
        <div class="bg-card p-4 sm:p-6 rounded-xl mb-6 border border-border mt-8">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-base font-semibold text-foreground mb-1">ÙØ±Ù… Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h3>
              <p class="text-sm text-muted-foreground">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ÙØ±Ù… Ø¨Ø±Ø§ÛŒ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ø¯ÛŒØ¯Ú©Ù†Ù†Ø¯Ú¯Ø§Ù†</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input 
                type="checkbox" 
                v-model="form.isLeadCaptureEnabled"
                class="sr-only peer"
              >
              <div class="w-11 h-6 bg-muted peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-card after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
            </label>
          </div>
        </div>
        
        <!-- Ù„ÛŒØ³Øª Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ -->
        <div v-if="form.links && form.links.length > 0" class="space-y-3 mb-6 mt-8">
          <h3 class="text-lg font-semibold text-foreground">Ù…Ø­ØªÙˆØ§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡</h3>
          <draggable
            v-model="form.links"
            :animation="200"
            ghost-class="ghost-item"
            chosen-class="chosen-item"
            drag-class="drag-item"
            item-key="id"
            handle=".drag-handle"
            class="space-y-2"
            @end="onDragEnd"
          >
            <template #item="{ element: link, index }">
              <div
                class="bg-card border border-border rounded-xl p-4 flex items-center justify-between hover:bg-muted/20 transition-all duration-200 group"
                :class="{'shadow-lg scale-[1.02]': isDragging}"
              >
                <!-- Handle Ù„Ù„Ø³Ø­Ø¨ -->
                <div class="flex items-center gap-3">
                  <div class="drag-handle cursor-grab active:cursor-grabbing transition-opacity p-2 -m-2 touch-none">
                    <i class="ti ti-grip-vertical text-muted-foreground text-xl"></i>
                  </div>
                  
                  <!-- Ø¢ÛŒÚ©ÙˆÙ† Ùˆ Ø¹Ù†ÙˆØ§Ù† -->
                  <div class="w-10 h-10 rounded-lg bg-muted flex items-center justify-center">
                    <!-- Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øª Ø¢ÛŒÚ©ÙˆÙ† Ø§ØµÙ„ÛŒ -->
                    <component
                      :is="getIconComponent(link)"
                      v-if="getIconComponent(link)"
                      :size="20"
                      :color="iconColor"
                      :filled="isIconFilled"
                    />
                    <!-- Fallback to image -->
                    <img
                      v-else-if="getSafeIconUrl(link)"
                      :src="getSafeIconUrl(link)"
                      class="w-5 h-5 object-contain"
                      alt="icon"
                    >
                    <!-- Fallback Ø¢ÛŒÚ©ÙˆÙ† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ -->
                    <i v-else :class="`ti ti-${getFallbackIcon(link)} text-muted-foreground`"></i>
                  </div>
                  <div>
                    <p class="font-medium text-foreground">{{ getLinkDisplayTitle(link) }}</p>
                    <!-- <p class="text-xs text-muted-foreground">{{ getLinkTypeLabel(link.action) }}</p> -->
                  </div>
                </div>
                
                <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
                <div class="flex items-center gap-2">
                  <button
                    @click="editLink(link, index)"
                    class="w-8 h-8 rounded-lg bg-muted hover:bg-muted-foreground/20 flex items-center justify-center transition-colors"
                  >
                    <i class="ti ti-edit text-sm text-muted-foreground"></i>
                  </button>
                  <button
                    @click="removeLink(index)"
                    class="w-8 h-8 rounded-lg bg-destructive/10 hover:bg-destructive/20 flex items-center justify-center transition-colors"
                  >
                    <i class="ti ti-trash text-sm text-destructive"></i>
                  </button>
                </div>
              </div>
            </template>
          </draggable>
        </div>
        
        <!-- Ú©Ø§Ø±Øª Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØªÙˆØ§ -->
        <div class="bg-card mt-4 rounded-xl  p-6 border border-border  hover:shadow-md transition-shadow">
          <div class="flex gap-4 mb-6">
            <!-- Ø¢ÛŒÚ©ÙˆÙ† -->
            <div class="w-12 h-12 bg-muted/40 rounded-xl flex items-center justify-center border-2 border-dashed border-border/60 hover:border-primary/50 hover:bg-primary/5 transition-colors">
              <i class="ti ti-plus text-muted-foreground text-xl"></i>
            </div>
            <!-- Ù…ØªÙ† -->
            <div class="flex-1">
              <h3 class="text-base font-semibold text-foreground mb-2">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØªÙˆØ§</h3>
              <p class="text-sm text-muted-foreground leading-relaxed">
                Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ØŒ Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒØŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ùˆ Ù…Ø­ØªÙˆØ§ÛŒ Ø¯ÛŒÚ¯Ø± Ø±Ø§ Ø¨Ù‡ Ú©Ø§Ø±Øª Ø®ÙˆØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯
              </p>
            </div>
          </div>
          <!-- Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† -->
          <button 
            @click="showAddModal = true"
            class="w-full bg-primary text-primary-foreground px-6 py-3.5 rounded-xl text-sm font-medium transition-all duration-200 flex items-center justify-center gap-3 hover:bg-primary/90 hover:shadow-lg transform hover:-translate-y-0.5"
          >
            <i class="ti ti-plus text-lg"></i>
            <span>Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØªÙˆØ§</span>
            <i class="ti ti-arrow-left text-sm"></i>
          </button>
        </div>

        <!-- ğŸ”¹ Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ - Ø¯Ø³Ú©ØªØ§Ù¾ -->
        <div class="hidden lg:block mt-8">
          <div class="flex justify-end">
            <button
              @click="saveChanges"
              :disabled="isSaving"
              class="bg-primary text-primary-foreground px-8 py-3.5 rounded-xl text-sm font-semibold transition-all duration-200 flex items-center justify-center gap-2 hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed  hover:shadow-md"
            >
              <template v-if="isSaving">
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm font-medium">Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...</span>
              </template>
              <template v-else>
                <i class="ti ti-device-floppy text-lg"></i>
                <span class="text-sm font-medium">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</span>
              </template>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¯Ø³Ú©ØªØ§Ù¾ -->
      <div class="lg:col-span-2 space-y-4 sticky z-0 top-16 h-fit w-full hidden lg:block">
        <div class="flex justify-center">
            <div class="relative" style="width: 390px; height: 844px;">
              <!-- ÙØ±ÛŒÙ… Ù…ÙˆØ¨Ø§ÛŒÙ„ iPhone 13 Pro -->
              <div class="absolute inset-0 rounded-[40px] border-4 border-gray-800 bg-black shadow-xl">
                <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ÙÛŒØ²ÛŒÚ©ÛŒ -->
                <div class="absolute top-[15%] -left-[5px] w-[4px] h-5 bg-slate-700 rounded-xl"></div>
                <div class="absolute top-[25%] -left-[5px] w-[4px] h-10 bg-slate-700 rounded-xl"></div>
                <div class="absolute top-[35%] -left-[5px] w-[4px] h-10 bg-slate-700 rounded-xl"></div>
                <div class="absolute top-[35%] -right-[5px] w-[4px] h-16 bg-slate-700 rounded-xl"></div>
                <!-- notch -->
                <div class="absolute top-3 left-1/2 -translate-x-1/2 w-16 h-5 bg-black rounded-xl z-20"></div>

                <!-- Ù…Ø­ØªÙˆØ§ÛŒ preview Ø¨Ø§ iframe ÙˆØ§Ù‚Ø¹ÛŒ -->
                <div class="absolute inset-2 rounded-[32px] overflow-hidden bg-white">
                  <!-- iframe ÙˆØ§Ù‚Ø¹ÛŒ -->
                  <ClientOnly>
                    <iframe
                        ref="iframeRef"
                        :key="`iframe-${iframeKey}`"
                        :src="previewUrl"
                        class="w-full h-full border-0 rounded-[28px] overflow-hidden"
                        sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
                        loading="lazy"
                        @load="onIframeLoad"
                    />
                    <template #fallback>
                      <div class="w-full h-full bg-gray-100 rounded-[28px] flex items-center justify-center">
                        <div class="text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                      </div>
                    </template>
                  </ClientOnly>
                </div>
              </div>
            </div>
        </div>
      </div>
    </div>

    <!-- ğŸ”¹ Ø¨Ø®Ø´ Ø«Ø§Ø¨Øª Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª - Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
    <div class="fixed bottom-0 left-0 right-0 bg-background/95 backdrop-blur-lg border-t border-border p-4 z-40 lg:hidden">
      <div class="max-w-4xl mx-auto flex gap-3">
        <!-- Ø¯Ú©Ù…Ù‡ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ -->
        <button
          @click="showPreviewMobile = true"
          class="flex-1 bg-muted text-foreground px-6 py-3 rounded-xl text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 hover:bg-muted/80"
        >
          <i class="ti ti-eye text-lg"></i>
          <span>Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´</span>
        </button>
        
        <!-- Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª -->
        <button
          @click="saveChanges"
          :disabled="isSaving"
          class="flex-2 bg-primary text-primary-foreground px-6 py-3 rounded-xl text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <template v-if="isSaving">
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm font-medium">Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...</span>
          </template>
          <template v-else>
            <i class="ti ti-device-floppy text-lg"></i>
            <span class="text-sm font-medium">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</span>
          </template>
        </button>
      </div>
    </div>

    <!-- ğŸ”¹ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¨Ø§ÛŒÙ„ - ÙÙˆÙ„ Ø§Ø³Ú©Ø±ÛŒÙ† -->
    <transition
        enter-active-class="transform transition ease-in-out duration-300"
        enter-from-class="translate-y-full"
        enter-to-class="translate-y-0"
        leave-active-class="transform transition ease-in-out duration-300"
        leave-from-class="translate-y-0"
        leave-to-class="translate-y-full"
    >
      <div
          v-if="showPreviewMobile"
          class="fixed inset-0 z-[9999] lg:hidden bg-white"
      >
        <!-- Ù‡Ø¯Ø± Ø«Ø§Ø¨Øª -->
        <div class="fixed top-0 left-0 right-0 z-10 bg-white border-b border-gray-200 safe-area-top">
          <div class="flex items-center justify-between px-4 py-3">
            <button
                @click="showPreviewMobile = false"
                class="flex items-center gap-2 text-gray-700 hover:text-gray-900 transition-colors"
            >
              <i class="ti ti-arrow-right text-xl"/>
              <span class="text-sm font-medium">Ø¨Ø§Ø²Ú¯Ø´Øª</span>
            </button>
            <h2 class="text-base font-semibold text-gray-800">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´</h2>
            <div class="w-16"></div>
          </div>
        </div>

        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ -->
        <div class="pt-14 h-full w-full bg-white">
          <ClientOnly>
            <iframe
                ref="iframeRef"
                :key="`iframe-mobile-${iframeKey}`"
                :src="previewUrl"
                class="w-full h-full border-0 bg-white"
                sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
                loading="lazy"
                @load="onIframeLoad"
            />
            <template #fallback>
              <div class="w-full h-full bg-white flex items-center justify-center">
                <div class="text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
              </div>
            </template>
          </ClientOnly>
        </div>
      </div>
    </transition>

    <!-- ğŸ”¹ Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ù„ÛŒÙ†Ú© -->
    <AddLinkModal
      v-if="showAddModal"
      :cardId="cardId"
      @close="showAddModal = false"
      @add-link="handleAddLink"
    />
    
    <!-- ğŸ”¹ Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØªÙˆØ§ (Ù…Ø«Ù„ AddLinkModal) -->
    <div v-if="showEditSheet" class="fixed inset-0 bg-black/50 backdrop-blur flex items-center justify-center z-[60] p-0 lg:p-4" @click.self="cancelEdit">
      <div class="bg-background rounded-none lg:rounded-2xl w-full h-full lg:max-w-md lg:h-auto lg:max-h-[90vh] overflow-y-auto overflow-x-hidden lg:shadow-2xl border-0 lg:border border-border">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b border-border bg-background sticky top-0 z-10">
          <button class="text-muted-foreground hover:text-foreground flex items-center gap-2 transition-colors" @click="cancelEdit">
            <i class="ti ti-arrow-right text-lg" />
            <span class="text-sm font-medium">Ø¨Ø±Ú¯Ø´Øª</span>
          </button>
          <h3 class="text-base font-semibold text-foreground">{{ getEditSheetTitle() }}</h3>
          <div class="flex items-center gap-2">
            <!-- Ø¯Ú©Ù…Ù‡ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„ÛŒÙ†Ú© - ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ URL Ù…Ø¹ØªØ¨Ø± -->
            <a 
              v-if="editingLink && getEditLinkUrl(editingLink)" 
              :href="getEditLinkUrl(editingLink)" 
              target="_blank"
              class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-muted text-muted-foreground hover:text-foreground transition-colors"
              title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„ÛŒÙ†Ú©"
            >
              <i class="ti ti-external-link text-lg" />
            </a>
            <!-- Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù -->
            <button 
              v-if="editingLink"
              type="button"
              class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-destructive/10 text-destructive hover:text-destructive/80 transition-colors"
              title="Ø­Ø°Ù"
              @click="() => { removeLink(editingLinkIndex); cancelEdit(); }"
            >
              <i class="ti ti-trash text-lg" />
            </button>
          </div>
        </div>

        <!-- Form Content -->
        <div class="flex-1">
          <component
            v-if="editingLink"
            :is="getEditComponent(editingLink)"
            :link="editingLink"
            :cardId="cardId"
            @cancel="cancelEdit"
            @back="cancelEdit"
            @submit="saveEditedLink"
            @delete="() => { removeLink(editingLinkIndex); cancelEdit(); }"
          />
        </div>
      </div>
    </div>
  </div>
  <InfoToast :visible="showToast" :message="toastMessage" :icon="toastIcon"/>
</template>

<script setup>
import {ref, computed, watch, onMounted, onUnmounted, toRaw} from 'vue'
import {useRoute} from '#app'
import {useSafeFormStore} from '~/composables/useSafeFormStore'
import TabAbout from '@/components/UserDashboard/main/EditCard/tabs/TabAbout.vue'
import AddLinkModal from '@/components/UserDashboard/modals/AddLinkModal.vue'
import BottomSheet from '@/components/ui/BottomSheet.vue'
import LayoutSelector from './components/LayoutSelector.vue'
import InfoToast from "~/components/UserDashboard/modals/InfoToast.vue"
import {useFormStore} from "~/stores/form.js"
import draggable from 'vuedraggable'
import {useIconComponents} from '~/composables/useIconComponentsMap'
import * as EditForms from '@/components/ui/forms/edit'

const props = defineProps({cardId: String, cardSlug: String})

// Stores
const formStore = useSafeFormStore()
const form = useFormStore()
const route = useRoute()

// Loading state
const isPageLoading = ref(true)

// Ø­Ø§Ù„Øª drag & drop
const isDragging = ref(false)

// Icon system
const {getIconComponent: getIconComponentFromMap, getSafeIcon} = useIconComponents()


// Toast
const showToast = ref(false)
const toastMessage = ref('')
const toastIcon = ref('ti-alert-triangle')
const showInfoToast = (message, icon = 'ti-check') => {
  toastMessage.value = message
  toastIcon.value = icon
  showToast.value = true
  setTimeout(() => showToast.value = false, 3000)
}

const cardId = computed(() => {
  // Check multiple sources for cardId with priority
  const id = props.cardId || 
             route.params.cardId || 
             route.query.id || 
             route.params.id ||
             formStore.selectedCardId ||
             null
  

  
  return id
})

// Icon color - same as preview
const iconColor = computed(() => {
  if (formStore.value.iconColor?.background && formStore.value.iconColor.background !== 'transparent') {
    return formStore.value.iconColor.background
  }
  return undefined
})

const isIconFilled = computed(() => {
  return !!(formStore.value.iconColor?.background && formStore.value.iconColor.background !== 'transparent')
})

// Modals
const showAddModal = ref(false)
const showContactForm = ref(false)
const showEditSheet = ref(false)

// Edit link state
const editingLink = ref(null)
const editingLinkIndex = ref(-1)

// Layout selection
const selectedLayout = ref(form.layout || 'right')

// Watch form layout changes to sync selectedLayout
watch(() => form.layout, (newLayout) => {
  if (newLayout && newLayout !== selectedLayout.value) {
    selectedLayout.value = newLayout
  }
}, { immediate: true })

// Functions
function handleAddLink(newItem) {
  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ store
  if (!form.links) {
    form.links = []
  }
  
  // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ - Ø­Ø°Ù description Ø§Ø¶Ø§ÙÛŒ
  const cleanedItem = { ...newItem }
  
  // Ø­Ø°Ù Ú©Ø§Ù…Ù„ description Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ ÛŒØ§ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø³Øª
  if (!cleanedItem.description || 
      cleanedItem.description.trim() === '' || 
      cleanedItem.description === 'description') {
    delete cleanedItem.description
  }
  
  // Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù„ÛŒÙ†Ú© Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ normalizeLink
  const normalizedLink = form.normalizeLink ? form.normalizeLink(cleanedItem) : {
    ...cleanedItem,
    id: cleanedItem.id || Date.now() + '_' + Math.random(),
    title: cleanedItem.title || cleanedItem.name || '',
    enabled: cleanedItem.enabled !== undefined ? cleanedItem.enabled : true
  }
  
  // Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø³Ø±ÙˆØ±
  createNewLink(normalizedLink)
  
  showInfoToast('Ù„ÛŒÙ†Ú© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'ti-check')
  showAddModal.value = false
}

// ØªØ§Ø¨Ø¹ Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø³Ø±ÙˆØ±
async function createNewLink(linkData) {
  if (!cardId.value) {
    console.warn('No cardId available for creating link')
    return
  }
  
  try {
    const nuxtApp = useNuxtApp()
    const axios = nuxtApp.$axios
    
    const payloadLink = {
      action: linkData.action || '',
      baseUrl: linkData.baseUrl || '',
      enabled: linkData.enabled !== undefined ? linkData.enabled : true,
      icon: linkData.icon ? JSON.stringify(linkData.icon) : null,
      id: linkData.id || `${Date.now()}_${Math.random().toString(36).slice(2)}`,
      name: linkData.name || '',
      title: linkData.title || '',
      type: linkData.type || 'link',
      value: linkData.value || '',
      username: linkData.username || '',
      placeholder: linkData.placeholder ? JSON.stringify(linkData.placeholder) : null,
      showDescription: linkData.showDescription || false,
      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ú©Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ø§Ø´Ø¯
      fullName: linkData.fullName || '',
      phoneNumber: linkData.phoneNumber || '',
      phoneRequired: linkData.phoneRequired || '',
      rewards: linkData.rewards || '',
      segments: linkData.segments || '',
      prizes: linkData.prizes || '',
      difficulty: linkData.difficulty || '',
      submitButtonText: linkData.submitButtonText || '',
      thankYouMessage: linkData.thankYouMessage || '',
      avatar: linkData.avatar || '',
      align: linkData.align || '',
      options: linkData.options || '',
      fileName: linkData.fileName || '',
      fileType: linkData.fileType || '',
      accountHolder: linkData.accountHolder || '',
      accountNumber: linkData.accountNumber || '',
      bankName: linkData.bankName || '',
      cardNumber: linkData.cardNumber || '',
      customBank: linkData.customBank || '',
      ibanNumber: linkData.ibanNumber || '',
      showBankDropdown: linkData.showBankDropdown || '',
      highlight: linkData.highlight || false,
      access: linkData.access || '',
      address: linkData.address || '',
      days: linkData.days || '',
      mode: linkData.mode || '',
      latitude: linkData.latitude || '',
      longitude: linkData.longitude || '',
      zoom: linkData.zoom || '',
      fields: linkData.fields || '',
      selectedItems: linkData.selectedItems || ''
    }
    
    // ÙÙ‚Ø· Ø§Ú¯Ø± description Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯ Ø¢Ù† Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
    if (linkData.description && linkData.description.trim() && linkData.description.trim() !== '') {
      payloadLink.description = linkData.description.trim()
    }
    
    // ÙÙ‚Ø· Ø§Ú¯Ø± customIcon Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯ Ø¢Ù† Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
    if (linkData.customIcon && linkData.customIcon.trim()) {
      payloadLink.customIcon = linkData.customIcon
    }
    
    console.log('Creating new link:', payloadLink)
    
    const response = await axios.post(`v1/cards/${cardId.value}/links`, {
      link: JSON.stringify(payloadLink)
    })
    
    if (response.data.success) {
      console.log('Link created successfully:', response.data.data)
      
      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ ID Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ù‡ store (Ù…Ø·Ø§Ø¨Ù‚ Ø¨Ø§ ØªØ¨ Ù„ÛŒÙ†Ú©)
      const normalizedNewLink = form.normalizeLink ? 
        form.normalizeLink(response.data.data) : 
        response.data.data
      
      // Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ù‡ links Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† ØªØ§ id Ø§Ø² Ø³Ø±ÙˆØ± Ø­ÙØ¸ Ø´ÙˆØ¯
      form.links.push(normalizedNewLink)
      
      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ iframe
      sendFormDataToIframe()
      
    } else {
      throw new Error(response.data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú©')
    }
    
  } catch (error) {
    console.error('Error creating link:', error)
    showInfoToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú©', 'ti-alert-triangle')
  }
}

function editLink(link, index) {
  // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ±Ù… ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ†Ú©
  
  // Map action names to icon names (for actions where icon name differs)
  const actionToIconMap = {
    'map': 'linkumap',
    'bank': 'card',
    'bankcard': 'card',
  }
  
  // Parse Ú©Ø±Ø¯Ù† icon Ø§Ú¯Ø± Ø±Ø´ØªÙ‡ JSON Ø§Ø³Øª
  let parsedIcon = link.icon
  if (typeof link.icon === 'string') {
    try {
      parsedIcon = JSON.parse(link.icon)
    } catch (e) {
      // Ø§Ú¯Ø± parse Ù†Ø´Ø¯ØŒ Ø§Ø² action Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª icon Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
      const actionLower = link.action?.toLowerCase()
      const iconName = actionToIconMap[actionLower] || actionLower
      parsedIcon = iconName ? { type: 'component', name: iconName, path: iconName } : null
    }
  }
  
  // Ø§Ú¯Ø± icon ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù‡ØŒ Ø§Ø² action Ø¨Ø³Ø§Ø²
  if (!parsedIcon && link.action) {
    const actionLower = link.action.toLowerCase()
    const iconName = actionToIconMap[actionLower] || actionLower
    parsedIcon = { type: 'component', name: iconName, path: iconName }
  }
  
  const editable = {
    ...link,
    icon: parsedIcon,
    type: link.type || (link.action?.includes('block') ? 'block' : 'link'),
    action: link.action?.toLowerCase() || 'basiclink',
    username: link.baseUrl && link.value?.startsWith(link.baseUrl)
        ? link.value.replace(link.baseUrl, '')
        : link.username || '',
  }

  // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ú©Ø§Ù…Ù„
  if (!editable.title) editable.title = link.name || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'
  if (!editable.value) editable.value = ''

  editingLink.value = editable
  editingLinkIndex.value = index
  showEditSheet.value = true
}

function cancelEdit() {
  showEditSheet.value = false
  editingLink.value = null
  editingLinkIndex.value = -1
}

function getEditSheetTitle() {
  if (!editingLink.value) return 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØªÙˆØ§'
  const actionTitles = {
    basiclink: 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù„ÛŒÙ†Ú©',
    email: 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø§ÛŒÙ…ÛŒÙ„',
    phone: 'ÙˆÛŒØ±Ø§ÛŒØ´ ØªÙ„ÙÙ†',
    whatsapp: 'ÙˆÛŒØ±Ø§ÛŒØ´ ÙˆØ§ØªØ³Ø§Ù¾',
    telegram: 'ÙˆÛŒØ±Ø§ÛŒØ´ ØªÙ„Ú¯Ø±Ø§Ù…',
    instagram: 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…',
    twitter: 'ÙˆÛŒØ±Ø§ÛŒØ´ ØªÙˆÛŒÛŒØªØ±',
    youtube: 'ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒÙˆØªÛŒÙˆØ¨',
    linkedin: 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù„ÛŒÙ†Ú©Ø¯ÛŒÙ†',
    map: 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ù‚Ø´Ù‡',
    text: 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù…ØªÙ†',
    faq: 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„',
    divider: 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡',
    contact: 'ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ±Ù… ØªÙ…Ø§Ø³',
    payment: 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª',
    file: 'ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ§ÛŒÙ„',
  }
  const action = editingLink.value.action?.toLowerCase()
  return actionTitles[action] || 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØªÙˆØ§'
}

// ØªØ§Ø¨Ø¹ Ú¯Ø±ÙØªÙ† Ø¹Ù†ÙˆØ§Ù† Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù„ÛŒØ³Øª Ù…Ø­ØªÙˆØ§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡
function getLinkDisplayTitle(link) {
  const defaultTitles = {
    'call': 'ØªÙ…Ø§Ø³',
    'number': 'Ù¾ÛŒØ§Ù…Ú©', 
    'email': 'Ø§ÛŒÙ…ÛŒÙ„',
    'whatsapp': 'ÙˆØ§ØªØ³Ø§Ù¾',
    'telegram': 'ØªÙ„Ú¯Ø±Ø§Ù…',
    'instagram': 'Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…',
    'linkedin': 'Ù„ÛŒÙ†Ú©Ø¯ÛŒÙ†',
    'twitter': 'ØªÙˆÛŒÛŒØªØ±',
    'youtube': 'ÛŒÙˆØªÛŒÙˆØ¨',
    'tiktok': 'ØªÛŒÚ©â€ŒØªØ§Ú©',
    'facebook': 'ÙÛŒØ³Ø¨ÙˆÚ©',
    'snapchat': 'Ø§Ø³Ù†Ù¾â€ŒÚ†Øª',
    'threads': 'ØªØ±Ø¯Ø²',
    'twitch': 'ØªÙˆÛŒÛŒÚ†',
    'rubika': 'Ø±ÙˆØ¨ÛŒÚ©Ø§',
    'bale': 'Ø¨Ù„Ù‡',
    'eitaa': 'Ø§ÛŒØªØ§',
    'igap': 'Ø¢ÛŒâ€ŒÚ¯Ù¾',
    'discord': 'Ø¯ÛŒØ³Ú©ÙˆØ±Ø¯',
    'map': 'Ù†Ù‚Ø´Ù‡',
    'address': 'Ø¢Ø¯Ø±Ø³',
    'poll': 'Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ',
    'questionbox': 'Ø¬Ø¹Ø¨Ù‡ Ø³ÙˆØ§Ù„',
    'expandabletext': 'Ù…ØªÙ† Ø¨Ø§Ø²Ø´ÙˆÙ†Ø¯Ù‡',
    'textsection': 'Ø¨Ø®Ø´ Ù…ØªÙ†ÛŒ',
    'file': 'ÙØ§ÛŒÙ„',
    'bankcard': 'Ú©Ø§Ø±Øª Ø¨Ø§Ù†Ú©ÛŒ',
    'workhours': 'Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ',
    'contactcard': 'Ú©Ø§Ø±Øª ØªÙ…Ø§Ø³',
    'embeddedvideo': 'ÙˆÛŒØ¯ÛŒÙˆ',
    'customlink': 'Ù„ÛŒÙ†Ú© Ø³ÙØ§Ø±Ø´ÛŒ',
    'luckydice': 'ØªØ§Ø³ Ø´Ø§Ù†Ø³',
    'luckywheel': 'Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø´Ø§Ù†Ø³',
    'luckyegg': 'ØªØ®Ù… Ù…Ø±Øº Ø´Ø§Ù†Ø³',
    'builder': 'ÙØ±Ù…â€ŒØ³Ø§Ø²',
    'spotify': 'Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ',
    'soundcloud': 'Ø³Ø§Ù†Ø¯Ú©Ù„ÙˆØ¯',
    'aparat': 'Ø¢Ù¾Ø§Ø±Ø§Øª',
    'virgool': 'ÙˆÛŒØ±Ú¯ÙˆÙ„',
  }
  
  const action = link.action?.toLowerCase()
  
  // Ø§Ú¯Ø± title Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯ (Ù†Ù‡ Ø®Ø§Ù„ÛŒ Ùˆ Ù†Ù‡ ÙÙ‚Ø· Ø¹Ø¯Ø¯/Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†)
  if (link.title && link.title.trim()) {
    const trimmedTitle = link.title.trim()
    // Ø§Ú¯Ø± title ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ù†ÛŒØ³Øª ÛŒØ§ Ø®ÛŒÙ„ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ù†ÛŒØ³Øª (Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†)
    if (!/^\+?[\d\s-]{8,20}$/.test(trimmedTitle) && !/^[\d]+$/.test(trimmedTitle)) {
      return trimmedTitle
    }
  }
  
  // Ø§Ú¯Ø± name Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯
  if (link.name && link.name.trim()) {
    return link.name.trim()
  }
  
  // Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¹Ù†ÙˆØ§Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø± Ø§Ø³Ø§Ø³ action
  if (action && defaultTitles[action]) {
    return defaultTitles[action]
  }
  
  return 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'
}

// ØªØ§Ø¨Ø¹ Ø¯Ø±ÛŒØ§ÙØª URL Ù„ÛŒÙ†Ú© Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù‡Ø¯Ø±
function getEditLinkUrl(link) {
  if (!link) return null
  
  // Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¨Ù„Ø§Ú©ÛŒ Ú©Ù‡ Ù„ÛŒÙ†Ú© Ø®Ø§Ø±Ø¬ÛŒ Ù†Ø¯Ø§Ø±Ù†Ø¯
  const blockActions = [
    'bankcard', 'workhours', 'embeddedvideo', 'file', 'poll', 
    'textsection', 'questionbox', 'expandabletext', 'builder',
    'luckydice', 'luckywheel', 'luckyegg', 'contactcard'
  ]
  
  if (link.action && blockActions.includes(link.action.toLowerCase())) {
    return null
  }
  
  // Ø§Ú¯Ø± baseUrl Ùˆ username Ø¯Ø§Ø±Ù‡ (Ø§ÙˆÙ„ÙˆÛŒØª Ø§ÙˆÙ„)
  if (link.baseUrl && link.username) {
    return link.baseUrl + link.username
  }
  
  // Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ø¨Ø§ username
  if (link.username && link.action) {
    const baseUrls = {
      telegram: 'https://t.me/',
      instagram: 'https://instagram.com/',
      twitter: 'https://x.com/',
      youtube: 'https://youtube.com/',
      linkedin: 'https://linkedin.com/in/',
      tiktok: 'https://www.tiktok.com/@',
      whatsapp: 'https://wa.me/',
      facebook: 'https://facebook.com/',
      threads: 'https://www.threads.net/@',
      snapchat: 'https://snapchat.com/add/',
      twitch: 'https://twitch.tv/',
      rubika: 'https://rubika.ir/',
      bale: 'https://ble.ir/',
      eitaa: 'https://eitaa.com/',
    }
    const base = baseUrls[link.action.toLowerCase()]
    if (base) return base + link.username
  }
  
  // Ø§Ú¯Ø± Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø§Ø±Ù‡
  if (link.value && (link.value.startsWith('http') || link.value.startsWith('mailto:') || link.value.startsWith('tel:'))) {
    return link.value
  }
  
  // Ø§Ú¯Ø± ÙÙ‚Ø· value Ø¯Ø§Ø±Ù‡ Ùˆ ÛŒÚ© URL Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³ØªØŒ null Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†
  return null
}

function getEditComponent(item) {
  if (!item || !item.action) return EditForms.basiclink
  const action = item.action.toLowerCase()

  // Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª
  if (Object.prototype.hasOwnProperty.call(EditForms, action)) {
    return EditForms[action]
  }

  // Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯ Ø¨Ø§ ÛŒÚ©ÛŒ Ø§Ø² ÙØ±Ù…â€ŒÙ‡Ø§ match Ú©Ù†Ø¯
  const altKey = Object.keys(EditForms).find(k => k.toLowerCase() === action)
  if (altKey) {
    return EditForms[altKey]
  }

  // Ù¾ÛŒØ´â€ŒÙØ±Ø¶: basiclink
  return EditForms.basiclink
}

async function saveEditedLink(updatedItem) {
  const item = {...updatedItem}
  if (item.baseUrl && item.username) {
    item.value = item.baseUrl + item.username
  }
  
  if (!item.id) return

  try {
    const nuxtApp = useNuxtApp()
    const axios = nuxtApp.$axios
    
    const payloadLink = {
      backgroundImage: item.backgroundImage ?? '',
      phoneRequired: item.phoneRequired ?? '',
      rewards: item.rewards ?? '',
      segments: item.segments ?? '',
      prizes: item.prizes ?? '',
      difficulty: item.difficulty ?? '',
      submitButtonText: item.submitButtonText ?? '',
      thankYouMessage: item.thankYouMessage ?? '',
      avatar: item.avatar ?? '',
      align: item.align ?? '',
      options: item.options ?? '',
      fileName: item.fileName ?? '',
      fileType: item.fileType ?? '',
      accountHolder: item.accountHolder ?? '',
      accountNumber: item.accountNumber ?? '',
      bankName: item.bankName ?? '',
      cardNumber: item.cardNumber ?? '',
      customBank: item.customBank ?? '',
      ibanNumber: item.ibanNumber ?? '',
      showBankDropdown: item.showBankDropdown ?? '',
      highlight: item.highlight ?? false,
      access: item.access ?? '',
      address: item.address ?? '',
      days: item.days ?? '',
      mode: item.mode ?? '',
      latitude: item.latitude ?? '',
      longitude: item.longitude ?? '',
      zoom: item.zoom ?? '',
      action: item.action ?? '',
      fields: item.fields ?? "",
      baseUrl: item.baseUrl ?? '',
      customIcon: item.customIcon ?? '',
      description: item.description ?? '',
      enabled: item.enabled,
      icon: item.icon 
        ? (typeof item.icon === 'string' ? item.icon : JSON.stringify(item.icon)) 
        : (item.action ? JSON.stringify({ type: 'component', name: item.action }) : null),
      id: item.id,
      name: item.name,
      username: item.username ?? '',
      selectedItems: item.selectedItems ?? '',
      placeholder: item.placeholder ? JSON.stringify(item.placeholder) : null,
      showDescription: item.showDescription ?? false,
      title: item.title,
      type: item.type,
      value: item.value ?? '',
    }

    const response = await axios.put(`v1/cards/${cardId.value}/links/${item.id}/update`, {link: JSON.stringify(payloadLink)})

    if (response.data?.success) {
      // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒÙ†Ú© Ø¯Ø± store Ù…Ø­Ù„ÛŒ
      const idx = form.links.findIndex(l => l.id === item.id)
      if (idx !== -1) {
        // Parse Ú©Ø±Ø¯Ù† icon Ø§Ø² response Ø§Ú¯Ø± Ø±Ø´ØªÙ‡ Ø§Ø³Øª
        const responseData = response.data.data || {}
        if (typeof responseData.icon === 'string') {
          try {
            responseData.icon = JSON.parse(responseData.icon)
          } catch (e) {
            responseData.icon = item.icon
          }
        }
        // Ø§Ú¯Ø± icon Ù†Ø¯Ø§Ø±Ù‡ØŒ Ø§Ø² item Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
        if (!responseData.icon) {
          responseData.icon = item.icon
        }
        
        form.links[idx] = {...item, ...responseData}
        form.links = [...form.links]
      }
      
      // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´
      showEditSheet.value = false
      editingLink.value = null
      editingLinkIndex.value = -1
      
      sendFormDataToIframe()
      showInfoToast(response.data.message || 'Ù„ÛŒÙ†Ú© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯', 'ti-check')
    } else {
      showInfoToast(response.data.message || 'Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù„ÛŒÙ†Ú©', 'ti-alert-triangle')
    }
  } catch (error) {
    if (error.response) {
      showInfoToast(error.response.data.message || 'Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù„ÛŒÙ†Ú©', 'ti-alert-triangle')
    } else {
      showInfoToast('Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯', 'ti-alert-triangle')
    }
  }
}

function removeLink(index) {
  // Ø­Ø°Ù Ù„ÛŒÙ†Ú© Ø§Ø² store Ùˆ Ø³Ø±ÙˆØ±
  if (form.links && form.links.length > index) {
    const linkToRemove = form.links[index]
    
    // Ø§Ú¯Ø± Ù„ÛŒÙ†Ú© id Ø¯Ø§Ø±Ù‡ØŒ Ø§Ø² Ø³Ø±ÙˆØ± Ø­Ø°Ù Ú©Ù†
    if (linkToRemove.id && cardId.value) {
      deleteLinkFromServer(linkToRemove.id, index)
    } else {
      // Ù„ÛŒÙ†Ú© Ù‡Ù†ÙˆØ² Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ØŒ ÙÙ‚Ø· Ø§Ø² UI Ø­Ø°Ù Ú©Ù†
      form.links.splice(index, 1)
      sendFormDataToIframe()
      showInfoToast('Ù„ÛŒÙ†Ú© Ø­Ø°Ù Ø´Ø¯', 'ti-check')
    }
  }
}

// ØªØ§Ø¨Ø¹ Ø­Ø°Ù Ù„ÛŒÙ†Ú© Ø§Ø² Ø³Ø±ÙˆØ±
async function deleteLinkFromServer(linkId, index) {
  if (!cardId.value || !linkId) {
    console.warn('No cardId or linkId available for deletion')
    // Ø­Ø°Ù Ø§Ø² UI Ø­ØªÛŒ Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ù†Ø¯Ø§Ø±ÛŒÙ…
    if (form.links && form.links.length > index) {
      form.links.splice(index, 1)
      sendFormDataToIframe()
      showInfoToast('Ù„ÛŒÙ†Ú© Ø­Ø°Ù Ø´Ø¯', 'ti-check')
    }
    return
  }
  
  try {
    const nuxtApp = useNuxtApp()
    const axios = nuxtApp.$axios
    
    console.log('Deleting link:', linkId)
    
    const response = await axios.delete(`v1/cards/${cardId.value}/links/${linkId}/delete`)
    
    if (response.data.success) {
      console.log('Link deleted successfully')
      
      // Ø­Ø°Ù Ø§Ø² store Ù…Ø­Ù„ÛŒ
      if (form.links && form.links.length > index) {
        form.links.splice(index, 1)
      }
      
      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ iframe
      sendFormDataToIframe()
      
      showInfoToast('Ù„ÛŒÙ†Ú© Ø­Ø°Ù Ø´Ø¯', 'ti-check')
    } else {
      // Ø­ØªÛŒ Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø² UI Ø­Ø°Ù Ú©Ù†
      if (form.links && form.links.length > index) {
        form.links.splice(index, 1)
      }
      sendFormDataToIframe()
      showInfoToast('Ù„ÛŒÙ†Ú© Ø­Ø°Ù Ø´Ø¯', 'ti-check')
    }
    
  } catch (error) {
    console.error('Error deleting link:', error)
    // Ø­ØªÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø§Ø² UI Ø­Ø°Ù Ú©Ù†
    if (form.links && form.links.length > index) {
      form.links.splice(index, 1)
    }
    sendFormDataToIframe()
    showInfoToast('Ù„ÛŒÙ†Ú© Ø­Ø°Ù Ø´Ø¯', 'ti-check')
  }
}

// ØªÙˆØ§Ø¨Ø¹ drag & drop
function onDragEnd(evt) {
  isDragging.value = false
  
  // Ø¯Ø± ØµÙˆØ±Øª ØªØºÛŒÛŒØ± ØªØ±ØªÛŒØ¨ØŒ Ù‡Ù…Ù‡ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
  if (evt.oldIndex !== evt.newIndex) {
    // Ø°Ø®ÛŒØ±Ù‡ ØªØ±ØªÛŒØ¨ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø³Ø±ÙˆØ±
    saveLinksOrder()
    
    sendFormDataToIframe()
    showInfoToast('ØªØ±ØªÛŒØ¨ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯', 'ti-arrows-move')
  }
}

// ØªØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡ ØªØ±ØªÛŒØ¨ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§
async function saveLinksOrder() {
  if (!cardId.value || !form.links || form.links.length === 0) {
    return
  }
  
  try {
    const nuxtApp = useNuxtApp()
    const axios = nuxtApp.$axios
    
    // Ø§Ø±Ø³Ø§Ù„ ØªØ±ØªÛŒØ¨ Ø¨Ø§ hash (API Ø¨Ø§ hash Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡)
    const hashOrder = form.links.map(link => link.hash)
    
    console.log('Saving links order by hash:', hashOrder)
    
    const response = await axios.post(`v1/cards/${cardId.value}/links/reorder`, {
      hashOrder: hashOrder
    })
    
    if (response.data.success) {
      console.log('Links order saved successfully')
    } else {
      throw new Error(response.data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØ±ØªÛŒØ¨ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§')
    }
    
  } catch (error) {
    console.error('Error saving links order:', error)
    // Ø§Ú¯Ø± endpoint ØªØ±ØªÛŒØ¨â€ŒØ¯Ù‡ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø² Ø±ÙˆØ´ Ú©Ù„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
    saveLinksToServer()
  }
}

// ØªÙˆØ§Ø¨Ø¹ Ø¢ÛŒÚ©ÙˆÙ†
function getIconComponent(link) {
  // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡Ù…Ø§Ù† Ø³ÛŒØ³ØªÙ… Ú©Ù‡ Ø¯Ø± LinkItem Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  const iconData = link.icon || null
  if (iconData && typeof iconData === 'object') {
    return getIconComponentFromMap(iconData)
  }
  return null
}

function getSafeIconUrl(link) {
  // Ø¨Ø±Ø±Ø³ÛŒ Ø¢ÛŒÚ©ÙˆÙ† URL
  return getSafeIcon(link)
}

function getFallbackIcon(link) {
  // Ø¢ÛŒÚ©ÙˆÙ† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ù„ÛŒÙ†Ú© (Ù‡Ù…Ø§Ù† getIconName Ù‚Ø¨Ù„ÛŒ)
  const iconMap = {
    // Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³
    'call': 'phone',
    'number': 'message',
    'email': 'mail',
    'telegram': 'brand-telegram',
    'whatsapp': 'brand-whatsapp',
    'eitaa': 'brand-telegram',
    'contactcard': 'id-badge-2',
    'address': 'map-pin',
    'facetime': 'video',
    'map': 'map',
    
    // Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ
    'instagram': 'brand-instagram',
    'facebook': 'brand-facebook',
    'tiktok': 'brand-tiktok',
    'twitter': 'brand-twitter',
    'x': 'brand-x',
    'linkedin': 'brand-linkedin',
    'youtube': 'brand-youtube',
    'aparat': 'video',
    'discord': 'brand-discord',
    'snapchat': 'brand-snapchat',
    'pinterest': 'brand-pinterest',
    'threads': 'brand-threads',
    'clubhouse': 'microphone',
    'twitch': 'brand-twitch',
    'rubika': 'message-circle',
    'bale': 'message-circle',
    'igap': 'message-circle',
    'medium': 'brand-medium',
    'virgool': 'article',
    
    // Ú©Ø³Ø¨ Ùˆ Ú©Ø§Ø±
    'website': 'world',
    'app_link': 'apps',
    'github': 'brand-github',
    'booksy': 'calendar',
    'calendly': 'calendar-event',
    'card': 'credit-card',
    'chili': 'chili',
    'etsy': 'shopping-bag',
    'reviews': 'star',
    'review': 'star',
    'square': 'square',
    'yelp': 'star',
    'divar': 'home',
    'snapp': 'car',
    'nshan': 'map',
    'neshan': 'map',
    'balad': 'map-pin',
    'figma': 'brand-figma',
    'googlemeet': 'video',
    'teams': 'brand-teams',
    'zoom': 'video',
    'trustpilot': 'star',
    'zillow': 'home',
    
    // Ù¾Ø±Ø¯Ø§Ø®Øª
    'cashapp': 'currency-dollar',
    'paypal': 'brand-paypal',
    'zelle': 'currency-dollar',
    'remit': 'currency-dollar',
    'reymit': 'currency-dollar',
    'zarinpal': 'credit-card',
    'trustwallet': 'wallet',
    
    // Ù…Ø­ØªÙˆØ§
    'customlink': 'external-link',
    'dropdown': 'chevron-down',
    'embeddedvideo': 'player-play',
    'featured': 'star',
    'featuredlink': 'star',
    'file': 'file',
    'textsection': 'file-text',
    'text-section': 'file-text',
    'poll': 'chart-bar',
    'questionbox': 'help-circle',
    
    // Ù…ÙˆØ²ÛŒÚ©
    'hoobe': 'music',
    'linktree': 'tree',
    'opensea_color': 'palette',
    'podcasts': 'microphone',
    'poshmark': 'shopping-bag',
    'spotify': 'brand-spotify',
    'youtube_music': 'music',
    'apple_music': 'music',
    
    // ÙØ±Ù… Ùˆ Ø¨Ø§Ø²ÛŒ
    'luckyegg': 'egg',
    'luckydice': 'dice',
    'luckywheel': 'wheel',
    'form': 'forms'
  }
  
  return iconMap[link.action] || 'link'
}

// ØªØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø¯Ø± Ø³Ø±ÙˆØ±
async function saveLinksToServer() {
  if (!cardId.value) {
    console.warn('No cardId available for saving links')
    return
  }
  
  try {
    const nuxtApp = useNuxtApp()
    const axios = nuxtApp.$axios
    
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡Ù…Ø§Ù† endpoint Ú©Ù‡ Ø¯Ø± ØªØ¨ Ù„ÛŒÙ†Ú© Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    const formData = new FormData()
    
    // Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø§ ÙØ±Ù…Øª ØµØ­ÛŒØ­
    const linksToSave = form.links ? form.links.map(link => {
      const cleanedLink = {
        ...link,
        // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
        id: link.id || Date.now() + '_' + Math.random(),
        title: link.title || link.name || '',
        action: link.action || 'customlink',
        url: link.url || '',
        enabled: link.enabled !== undefined ? link.enabled : true,
        icon: link.icon || null,
        customIcon: link.customIcon || null,
        isListMode: link.isListMode !== undefined ? link.isListMode : true
      }
      
      // ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯ description Ù…Ø¹ØªØ¨Ø± Ø¢Ù† Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
      if (link.description && link.description.trim() && link.description.trim() !== '') {
        cleanedLink.description = link.description.trim()
      }
      // Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª description Ø§ØµÙ„Ø§Ù‹ Ø§Ø±Ø³Ø§Ù„ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯
      
      return cleanedLink
    }) : []
    
    formData.append('linksDataList', JSON.stringify(linksToSave))
    
    console.log('Saving links to server:', linksToSave)
    
    const response = await axios.post(`v1/cards/${cardId.value}/update`, formData, {
      headers: {'X-HTTP-Method-Override': 'PUT'}
    })
    
    if (response.data.success) {
      console.log('Links saved successfully')
      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ iframe
      sendFormDataToIframe()
    } else {
      throw new Error(response.data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§')
    }
    
  } catch (error) {
    console.error('Error saving links:', error)
    showInfoToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§', 'ti-alert-triangle')
  }
}

// ØªØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡ ØªÚ© Ù„ÛŒÙ†Ú© (Ù…Ø´Ø§Ø¨Ù‡ ØªØ¨ Ù„ÛŒÙ†Ú©)
async function saveSingleLink(link) {
  if (!cardId.value || !link.id) {
    console.warn('No cardId or linkId available')
    return false
  }
  
  try {
    const nuxtApp = useNuxtApp()
    const axios = nuxtApp.$axios
    
    const payloadLink = {
      action: link.action || '',
      baseUrl: link.baseUrl || '',
      customIcon: link.customIcon || '',
      description: link.description || '',
      enabled: link.enabled,
      icon: link.icon ? JSON.stringify(link.icon) : null,
      id: link.id,
      name: link.name,
      title: link.title,
      type: link.type,
      value: link.value || '',
      username: link.username || '',
      placeholder: link.placeholder ? JSON.stringify(link.placeholder) : null,
      showDescription: link.showDescription || false,
      isListMode: link.isListMode !== undefined ? link.isListMode : true
    }
    
    const response = await axios.put(`v1/cards/${cardId.value}/links/${link.id}/update`, {
      link: JSON.stringify(payloadLink)
    })
    
    if (response.data.success) {
      console.log('Single link saved successfully')
      return true
    } else {
      throw new Error(response.data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú©')
    }
    
  } catch (error) {
    console.error('Error saving single link:', error)
    showInfoToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú©', 'ti-alert-triangle')
    return false
  }
}

function getLinkTypeLabel(action) {
  // Ø¨Ø±Ú†Ø³Ø¨ Ù†ÙˆØ¹ Ù„ÛŒÙ†Ú© (Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø¨Ø§ data.ts)
  const labels = {
    // Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³
    'call': 'ØªÙ…Ø§Ø³',
    'number': 'Ù¾ÛŒØ§Ù…',
    'email': 'Ø§ÛŒÙ…ÛŒÙ„',
    'telegram': 'ØªÙ„Ú¯Ø±Ø§Ù…',
    'whatsapp': 'ÙˆØ§ØªØ³Ø§Ù¾',
    'eitaa': 'Ø§ÛŒØªØ§',
    'contactcard': 'Ú©Ø§Ø±Øª ØªÙ…Ø§Ø³',
    'address': 'Ø¢Ø¯Ø±Ø³',
    'facetime': 'ÙÛŒØ³â€ŒØªØ§ÛŒÙ…',
    'map': 'Ù†Ù‚Ø´Ù‡',
    
    // Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ
    'instagram': 'Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…',
    'facebook': 'ÙÛŒØ³Ø¨ÙˆÚ©',
    'tiktok': 'ØªÛŒÚ©â€ŒØªØ§Ú©',
    'twitter': 'ØªÙˆÛŒØªØ±',
    'x': 'Ø§ÛŒÚ©Ø³',
    'linkedin': 'Ù„ÛŒÙ†Ú©Ø¯ÛŒÙ†',
    'youtube': 'ÛŒÙˆØªÛŒÙˆØ¨',
    'aparat': 'Ø¢Ù¾Ø§Ø±Ø§Øª',
    'discord': 'Ø¯ÛŒØ³Ú©ÙˆØ±Ø¯',
    'snapchat': 'Ø§Ø³Ù†Ù¾Ú†Øª',
    'pinterest': 'Ù¾ÛŒÙ†ØªØ±Ø³Øª',
    'threads': 'ØªØ±Ø¯Ø²',
    'clubhouse': 'Ú©Ù„Ø§Ø¨â€ŒÙ‡Ø§ÙˆØ³',
    'twitch': 'ØªÙˆÛŒÚ†',
    'rubika': 'Ø±ÙˆØ¨ÛŒÚ©Ø§',
    'bale': 'Ø¨Ù„Ù‡',
    'igap': 'Ø¢ÛŒÚ¯Ù¾',
    'medium': 'Ù…Ø¯ÛŒÙˆÙ…',
    'virgool': 'ÙˆÛŒØ±Ú¯ÙˆÙ„',
    
    // Ú©Ø³Ø¨ Ùˆ Ú©Ø§Ø±
    'website': 'ÙˆØ¨Ø³Ø§ÛŒØª',
    'app_link': 'Ù„ÛŒÙ†Ú© Ø§Ù¾',
    'github': 'Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨',
    'booksy': 'Ø¨ÙˆÚ©Ø³ÛŒ',
    'calendly': 'ØªÙ‚ÙˆÛŒÙ…',
    'card': 'Ú©Ø§Ø±Øª Ø¨Ø§Ù†Ú©ÛŒ',
    'etsy': 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡',
    'reviews': 'Ù†Ø¸Ø±Ø§Øª',
    'review': 'Ù†Ø¸Ø±',
    'divar': 'Ø¯ÛŒÙˆØ§Ø±',
    'snapp': 'Ø§Ø³Ù†Ù¾',
    'nshan': 'Ù†Ø´Ø§Ù†',
    'neshan': 'Ù†Ø´Ø§Ù†',
    'balad': 'Ø¨Ù„Ø¯',
    'figma': 'ÙÛŒÚ¯Ù…Ø§',
    'googlemeet': 'Ú¯ÙˆÚ¯Ù„ Ù…ÛŒØª',
    'teams': 'ØªÛŒÙ…Ø²',
    'zoom': 'Ø²ÙˆÙ…',
    
    // Ù¾Ø±Ø¯Ø§Ø®Øª
    'cashapp': 'Ú©Ø´ Ø§Ù¾',
    'paypal': 'Ù¾ÛŒâ€ŒÙ¾Ø§Ù„',
    'zelle': 'Ø²Ù„',
    'remit': 'Ø±Ù…ÛŒØª',
    'reymit': 'Ø±Ù…ÛŒØª',
    'zarinpal': 'Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„',
    'trustwallet': 'ØªØ±Ø§Ø³Øª ÙˆØ§Ù„Øª',
    
    // Ù…Ø­ØªÙˆØ§
    'customlink': 'Ù„ÛŒÙ†Ú© Ø³ÙØ§Ø±Ø´ÛŒ',
    'dropdown': 'Ù„ÛŒØ³Øª Ú©Ø´ÙˆÛŒÛŒ',
    'embeddedvideo': 'ÙˆÛŒØ¯Ø¦Ùˆ',
    'featured': 'ÙˆÛŒÚ˜Ù‡',
    'featuredlink': 'Ù„ÛŒÙ†Ú© ÙˆÛŒÚ˜Ù‡',
    'file': 'ÙØ§ÛŒÙ„',
    'textsection': 'Ù…ØªÙ†',
    'text-section': 'Ù…ØªÙ†',
    'poll': 'Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ',
    'questionbox': 'ØµÙ†Ø¯ÙˆÙ‚ Ù¾Ø±Ø³Ø´',
    
    // Ù…ÙˆØ²ÛŒÚ©
    'hoobe': 'Ù‡ÙˆØ¨Ù‡',
    'linktree': 'Ù„ÛŒÙ†Ú©â€ŒØªØ±ÛŒ',
    'opensea_color': 'Ø§ÙˆÙ¾Ù†â€ŒØ³ÛŒ',
    'podcasts': 'Ù¾Ø§Ø¯Ú©Ø³Øª',
    'spotify': 'Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ',
    'youtube_music': 'ÛŒÙˆØªÛŒÙˆØ¨ Ù…ÙˆØ²ÛŒÚ©',
    'apple_music': 'Ø§Ù¾Ù„ Ù…ÙˆØ²ÛŒÚ©',
    
    // ÙØ±Ù… Ùˆ Ø¨Ø§Ø²ÛŒ
    'luckyegg': 'ØªØ®Ù… Ø´Ø§Ù†Ø³',
    'luckydice': 'ØªØ§Ø³ Ø´Ø§Ù†Ø³',
    'luckywheel': 'Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø´Ø§Ù†Ø³',
    'form': 'ÙØ±Ù…'
  }
  
  return labels[action] || 'Ù„ÛŒÙ†Ú©'
}

function handleLayoutChange(layout) {
}

async function handleLayoutConfirm(layout) {
  try {
    // Update local stores first
    if (formStore.value) {
      formStore.value.layout = layout
    }
    form.layout = layout
    
    // Save to API if cardId exists
    if (props.cardId) {
      const formData = new FormData()
      formData.append('layoutMode', layout)
      
      // Also save current theme colors if they exist  
      if (form.themeColor) {
        formData.append('themeColor', JSON.stringify(form.themeColor))
      }
      if (form.iconColor) {
        formData.append('iconColor', JSON.stringify(form.iconColor))
      }
      
      const nuxtApp = useNuxtApp()
      const axios = nuxtApp.$axios
      const response = await axios.post(`v1/cards/${props.cardId}/update`, formData, {
        headers: {'X-HTTP-Method-Override': 'PUT'}
      })
      
      if (response.data.success) {
        showInfoToast('Ú†ÛŒØ¯Ù…Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'ti-check')
      } else {
        throw new Error(response.data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú†ÛŒØ¯Ù…Ø§Ù†')
      }
    } else {
      showInfoToast('Ú†ÛŒØ¯Ù…Ø§Ù† ØªØºÛŒÛŒØ± Ú©Ø±Ø¯', 'ti-check')
    }
    
  } catch (error) {
    showInfoToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú†ÛŒØ¯Ù…Ø§Ù†', 'ti-alert-triangle')
  }
}

function goBack() {
  // Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ù„ÛŒÙ†Ú© Ù‡Ø³ØªÛŒÙ…ØŒ Ø§ÙˆÙ„ ÙØ±Ù… Ø§Ø¯ÛŒØª Ø±Ùˆ Ø¨Ø¨Ù†Ø¯
  if (editingLink.value) {
    cancelEdit()
    return
  }
  
  // Ø¨Ø±Ø±Ø³ÛŒ PWA standalone mode
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                       (window.navigator).standalone === true
  
  // Ø¯Ø± PWA Ø§Ú¯Ø± history Ú©Ù… Ø§Ø³ØªØŒ Ø¨Ù‡ dashboard Ø¨Ø±Ùˆ Ø¨Ø¬Ø§ÛŒ back
  if (isStandalone) {
    // Ø¯Ø± PWA Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ù‡ dashboard Ø¨Ø±Ùˆ ØªØ§ Ø§Ø² Ø§Ù¾ Ø®Ø§Ø±Ø¬ Ù†Ø´Ù‡
    window.location.href = '/dashboard'
  } else if (window.history.length > 2) {
    window.history.back()
  } else {
    window.location.href = '/dashboard'
  }
}

function goToLeadCapture() {
  console.log('goToLeadCapture clicked!')
  window.location.href = '/profile/lead-capture'
}

// Save state
const isSaving = ref(false)

const saveChanges = () => {
  isSaving.value = true
  const saveEvent = new CustomEvent('manual-save', {
    detail: { source: 'header-save' }
  })
  window.dispatchEvent(saveEvent)
  
  setTimeout(() => {
    isSaving.value = false
    showInfoToast('ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'ti-check')
  }, 2000)
}

// Iframe
const {$axios} = useNuxtApp()
const iframeRef = ref(null)
const iframeKey = ref(0)
const showPreviewMobile = ref(false)
const isIframeLoading = ref(true)
const isIframeReady = ref(false)

const previewUrl = computed(() => {
  if (typeof window === 'undefined') return 'about:blank'

  const params = new URLSearchParams()
  params.set('t', Date.now().toString())
  params.set('cardId', String(cardId.value))
  params.set('isDefault', '1')
  const slug = props.cardSlug || 'editCard'

  return `${window.location.origin}/preview/${slug}?${params.toString()}`
})

const onIframeLoad = () => {
  isIframeLoading.value = false
}

const sendFormDataToIframe = () => {
  if (!process.client || !isIframeReady.value || !iframeRef.value?.contentWindow) return
  
  try {
    // Use toRaw to avoid RefImpl serialization issues
    const rawFormData = toRaw(form.$state)
    iframeRef.value.contentWindow.postMessage({
      type: 'FORM_DATA_UPDATE',
      data: JSON.parse(JSON.stringify(rawFormData))
    }, window.location.origin)
  } catch (error) {
  }
}

const handleIframeMessage = (event) => {
  if (!process.client) return
  if (event.origin !== window.location.origin) return

  if (event.data?.type === 'IFRAME_READY') {
    isIframeReady.value = true
    sendFormDataToIframe()
  }
}

// Lifecycle
onMounted(async () => {
  if (process.client) {
    window.addEventListener('message', handleIframeMessage)
    
    // Load card data and layout from API
    const resolvedCardId = cardId.value
    if (resolvedCardId) {
      try {
        
        // Set card data in form store
        await form.setAboutFrom(resolvedCardId)
      } catch (error) {
        console.error('Error loading card:', error)
      }
    } else {
      // Try to get default card if available
      if (formStore.cards && formStore.cards.length > 0) {
        const defaultCard = formStore.defaultCard || formStore.cards[0]
        if (defaultCard?.id) {
          await form.setAboutFrom(defaultCard.id)
        }
      }
    }
    
    // Hide loading after data is loaded
    setTimeout(() => {
      isPageLoading.value = false
    }, 300)
  }
})

// Watch for form changes to send real-time updates to preview
watch(() => form.$state, () => {
  if (process.client) {
    sendFormDataToIframe()
  }
}, { deep: true })

watch(() => form.cards, (c) => {
  if (process.client) {
    form.setAboutFrom(String(cardId.value))
  }
}, {immediate: true})

// Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø¨ÛŒÙ† stores
watch(() => form.links, (newLinks) => {
  if (formStore.value) {
    formStore.value.links = newLinks || []
  }
}, { deep: true, immediate: true })

// Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø³ÙˆØ¦ÛŒÚ† ÙØ±Ù… Ù„ÛŒØ¯
watch(() => form.isLeadCaptureEnabled, async (newValue, oldValue) => {
  console.log('Lead capture watch triggered:', { newValue, oldValue, cardId: cardId.value })
  
  // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ ØªØºÛŒÛŒØ± ÙˆØ§Ù‚Ø¹ÛŒ Ø±Ø® Ø¯Ø§Ø¯Ù‡
  if (newValue === oldValue) {
    console.log('No change in lead capture value, skipping')
    return
  }
  
  if (cardId.value) {
    try {
      const nuxtApp = useNuxtApp()
      const axios = nuxtApp.$axios
      
      console.log('Saving lead capture mode:', newValue, 'for card:', cardId.value)
      
      const formData = new FormData()
      formData.append('leadCaptureMode', newValue ? '1' : '0')
      
      const response = await axios.post(`v1/cards/${cardId.value}/update`, formData, {
        headers: {'X-HTTP-Method-Override': 'PUT'}
      })
      
      if (response.data.success) {
        console.log('ÙØ±Ù… Ù„ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯:', newValue)
        showInfoToast(newValue ? 'ÙØ±Ù… Ù„ÛŒØ¯ ÙØ¹Ø§Ù„ Ø´Ø¯' : 'ÙØ±Ù… Ù„ÛŒØ¯ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯', 'ti-check')
      } else {
        throw new Error(response.data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÙØ±Ù… Ù„ÛŒØ¯')
      }
    } catch (error) {
      console.error('Error saving lead capture setting:', error)
      showInfoToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ±Ù…', 'ti-alert-triangle')
      
      // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¨Ù‡ Ø­Ø§Ù„Øª Ù‚Ø¨Ù„ÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
      setTimeout(() => {
        form.isLeadCaptureEnabled = oldValue
      }, 100)
    }
  } else {
    console.warn('No cardId available for saving lead capture setting')
    showInfoToast('Ø®Ø·Ø§: Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª', 'ti-alert-triangle')
    
    // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¨Ù‡ Ø­Ø§Ù„Øª Ù‚Ø¨Ù„ÛŒ
    setTimeout(() => {
      form.isLeadCaptureEnabled = oldValue
    }, 100)
  }
})

onUnmounted(() => {
  if (process.client) {
    window.removeEventListener('message', handleIframeMessage)
  }
})
</script>
<style scoped>
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.2s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}

.no-scrollbar::-webkit-scrollbar {
  display: none;
}

.no-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ drag & drop */
.ghost-item {
  opacity: 0.4;
  background: rgb(var(--primary) / 0.1);
  border: 2px dashed rgb(var(--primary) / 0.3);
  transform: scale(1.05);
  transition: all 0.2s ease;
}

.chosen-item {
  opacity: 0.8;
  transform: scale(1.02);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  border: 2px solid rgb(var(--primary) / 0.5);
  z-index: 999;
}

.drag-item {
  opacity: 0.9;
  transform: rotate(2deg) scale(1.05);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
  transition: transform 0.2s ease;
}

.drag-handle {
  touch-action: none;
  user-select: none;
  -webkit-touch-callout: none;
}

.safe-area-top {
  padding-top: env(safe-area-inset-top, 0px);
}

/* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ hover */
.group:hover .drag-handle {
  animation: wiggle 0.8s ease-in-out;
}

@keyframes wiggle {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-2px); }
  50% { transform: translateX(2px); }
  75% { transform: translateX(-1px); }
}
</style>